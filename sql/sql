-- ========================================
-- TRANSPORT MANAGEMENT SYSTEM - DATABASE
-- ========================================

DROP DATABASE IF EXISTS transport_management;
CREATE DATABASE transport_management CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE transport_management;

-- ========================================
-- 1. TABLA DE USUARIOS Y AUTENTICACIÓN
-- ========================================

CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    full_name VARCHAR(100) NOT NULL,
    role ENUM('admin', 'operator') DEFAULT 'operator',
    avatar VARCHAR(255) NULL,
    phone VARCHAR(20) NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    last_login TIMESTAMP NULL,
    is_active BOOLEAN DEFAULT TRUE,
    failed_login_attempts INT DEFAULT 0,
    locked_until TIMESTAMP NULL,
    
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_role (role),
    INDEX idx_active (is_active)
);

-- ========================================
-- 2. TABLA DE EMPRESAS DE TRANSPORTE
-- ========================================

CREATE TABLE companies (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(150) NOT NULL,
    legal_name VARCHAR(200) NULL,
    tax_id VARCHAR(50) UNIQUE NULL, -- RFC o NIT
    contact_person VARCHAR(100) NULL,
    phone VARCHAR(20) NULL,
    email VARCHAR(100) NULL,
    address TEXT NULL,
    city VARCHAR(100) NULL,
    state VARCHAR(100) NULL,
    postal_code VARCHAR(10) NULL,
    country VARCHAR(50) DEFAULT 'México',
    
    -- Configuración de deducciones por empresa
    deduction_type ENUM('percentage', 'fixed_amount') DEFAULT 'percentage',
    deduction_value DECIMAL(10,2) DEFAULT 0.00,
    deduction_description VARCHAR(255) NULL,
    
    -- Configuración de pagos
    bank_name VARCHAR(100) NULL,
    account_number VARCHAR(50) NULL,
    clabe VARCHAR(18) NULL,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    created_by INT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    
    FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL,
    INDEX idx_name (name),
    INDEX idx_tax_id (tax_id),
    INDEX idx_active (is_active)
);

-- ========================================
-- 3. TABLA DE VOUCHERS (PDFs SUBIDOS)
-- ========================================

CREATE TABLE vouchers (
    id INT PRIMARY KEY AUTO_INCREMENT,
    voucher_number VARCHAR(100) NOT NULL,
    original_filename VARCHAR(255) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    file_size INT NOT NULL, -- en bytes
    upload_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    period_start DATE NULL,
    period_end DATE NULL,
    
    -- Estado del procesamiento
    status ENUM('uploaded', 'processing', 'processed', 'error') DEFAULT 'uploaded',
    processing_notes TEXT NULL,
    
    -- Totales generales del voucher
    total_amount DECIMAL(12,2) DEFAULT 0.00,
    total_companies INT DEFAULT 0,
    total_trips INT DEFAULT 0,
    
    uploaded_by INT NOT NULL,
    processed_at TIMESTAMP NULL,
    processed_by INT NULL,
    
    FOREIGN KEY (uploaded_by) REFERENCES users(id) ON DELETE RESTRICT,
    FOREIGN KEY (processed_by) REFERENCES users(id) ON DELETE SET NULL,
    
    INDEX idx_voucher_number (voucher_number),
    INDEX idx_status (status),
    INDEX idx_upload_date (upload_date),
    INDEX idx_uploaded_by (uploaded_by)
);

-- ========================================
-- 4. TABLA DE VIAJES EXTRAÍDOS
-- ========================================

CREATE TABLE trips (
    id INT PRIMARY KEY AUTO_INCREMENT,
    voucher_id INT NOT NULL,
    company_id INT NOT NULL,
    
    -- Información del viaje
    trip_date DATE NOT NULL,
    origin VARCHAR(200) NOT NULL,
    destination VARCHAR(200) NOT NULL,
    vehicle_plate VARCHAR(20) NULL,
    driver_name VARCHAR(100) NULL,
    
    -- Detalles de carga
    product_type VARCHAR(100) NULL,
    weight_tons DECIMAL(8,2) NOT NULL DEFAULT 0.00,
    
    -- Información financiera
    unit_rate DECIMAL(10,2) NOT NULL DEFAULT 0.00, -- tarifa por tonelada
    subtotal DECIMAL(12,2) NOT NULL DEFAULT 0.00,
    
    -- Deducciones aplicadas
    deduction_type ENUM('percentage', 'fixed_amount') NULL,
    deduction_value DECIMAL(10,2) DEFAULT 0.00,
    deduction_amount DECIMAL(12,2) DEFAULT 0.00,
    
    -- Total final
    total_amount DECIMAL(12,2) NOT NULL DEFAULT 0.00,
    
    -- Referencia del ticket/documento
    ticket_number VARCHAR(100) NULL,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (voucher_id) REFERENCES vouchers(id) ON DELETE CASCADE,
    FOREIGN KEY (company_id) REFERENCES companies(id) ON DELETE RESTRICT,
    
    INDEX idx_voucher_company (voucher_id, company_id),
    INDEX idx_trip_date (trip_date),
    INDEX idx_vehicle (vehicle_plate),
    INDEX idx_ticket (ticket_number)
);

-- ========================================
-- 5. TABLA DE REPORTES GENERADOS (HISTORIAL INDEFINIDO)
-- ========================================

CREATE TABLE reports (
    id INT PRIMARY KEY AUTO_INCREMENT,
    voucher_id INT NOT NULL,
    company_id INT NOT NULL,
    
    -- Información del reporte (para búsquedas rápidas)
    report_number VARCHAR(100) NOT NULL,
    report_title VARCHAR(200) NOT NULL,
    generation_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- Período del reporte (campos clave para búsquedas)
    period_start DATE NOT NULL,
    period_end DATE NOT NULL,
    report_year YEAR AS (YEAR(period_start)) STORED, -- Campo calculado para búsquedas anuales
    report_month TINYINT AS (MONTH(period_start)) STORED, -- Campo calculado para búsquedas mensuales
    
    -- Información de la empresa (desnormalizada para búsquedas rápidas)
    company_name VARCHAR(150) NOT NULL, -- Copiado de companies.name al generar
    company_tax_id VARCHAR(50) NULL, -- Copiado de companies.tax_id al generar
    
    -- Archivo generado (NUNCA se elimina)
    file_path VARCHAR(500) NOT NULL,
    file_size INT NOT NULL,
    file_hash VARCHAR(64) NULL, -- SHA256 para verificar integridad
    
    -- Resumen financiero
    total_trips INT NOT NULL DEFAULT 0,
    total_weight DECIMAL(10,2) DEFAULT 0.00,
    gross_amount DECIMAL(12,2) DEFAULT 0.00,
    total_deductions DECIMAL(12,2) DEFAULT 0.00,
    net_amount DECIMAL(12,2) DEFAULT 0.00,
    
    -- Configuración de deducciones aplicada (histórica)
    deduction_type_applied ENUM('percentage', 'fixed_amount') NULL,
    deduction_value_applied DECIMAL(10,2) DEFAULT 0.00,
    
    -- Estado y seguimiento
    status ENUM('generated', 'sent', 'paid', 'cancelled') DEFAULT 'generated',
    sent_date TIMESTAMP NULL,
    payment_date TIMESTAMP NULL,
    
    -- Auditoría
    generated_by INT NOT NULL,
    notes TEXT NULL,
    tags VARCHAR(500) NULL, -- Para categorización adicional
    
    -- Control de versiones (si se regenera el mismo período)
    version INT DEFAULT 1,
    is_latest_version BOOLEAN DEFAULT TRUE,
    previous_version_id INT NULL,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (voucher_id) REFERENCES vouchers(id) ON DELETE RESTRICT, -- Cambio a RESTRICT
    FOREIGN KEY (company_id) REFERENCES companies(id) ON DELETE RESTRICT,
    FOREIGN KEY (generated_by) REFERENCES users(id) ON DELETE RESTRICT,
    FOREIGN KEY (previous_version_id) REFERENCES reports(id) ON DELETE SET NULL,
    
    -- Índices optimizados para búsquedas frecuentes
    INDEX idx_report_number (report_number),
    INDEX idx_generation_date (generation_date),
    
    -- ÍNDICES CLAVE PARA BÚSQUEDAS POR FECHA Y EMPRESA
    INDEX idx_company_period (company_id, period_start, period_end),
    INDEX idx_company_name_date (company_name, period_start),
    INDEX idx_period_company (period_start, period_end, company_id),
    INDEX idx_year_month (report_year, report_month),
    INDEX idx_company_year (company_id, report_year),
    
    -- Índices adicionales para filtros comunes
    INDEX idx_status_date (status, generation_date),
    INDEX idx_latest_version (is_latest_version, company_id),
    INDEX idx_tags (tags),
    
    -- Índice compuesto para búsquedas complejas
    INDEX idx_search_combo (company_id, report_year, report_month, status),
    
    -- Eliminar restricción única para permitir múltiples reportes por empresa/voucher
    -- UNIQUE KEY unique_voucher_company (voucher_id, company_id), -- REMOVIDO
    
    -- Restricción única para evitar duplicados de la misma versión
    UNIQUE KEY unique_voucher_company_version (voucher_id, company_id, version)
);

-- ========================================
-- 6. TABLA DE CONFIGURACIONES DEL SISTEMA
-- ========================================

CREATE TABLE system_settings (
    id INT PRIMARY KEY AUTO_INCREMENT,
    setting_key VARCHAR(100) UNIQUE NOT NULL,
    setting_value TEXT NULL,
    setting_type ENUM('string', 'number', 'boolean', 'json') DEFAULT 'string',
    description TEXT NULL,
    category VARCHAR(50) DEFAULT 'general',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    updated_by INT NULL,
    
    FOREIGN KEY (updated_by) REFERENCES users(id) ON DELETE SET NULL,
    INDEX idx_category (category),
    INDEX idx_key (setting_key)
);

-- ========================================
-- 7. TABLA DE LOGS/AUDITORÍA
-- ========================================

CREATE TABLE activity_logs (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NULL,
    action VARCHAR(100) NOT NULL,
    table_name VARCHAR(50) NULL,
    record_id INT NULL,
    description TEXT NULL,
    ip_address VARCHAR(45) NULL,
    user_agent TEXT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL,
    INDEX idx_user_action (user_id, action),
    INDEX idx_table_record (table_name, record_id),
    INDEX idx_created_at (created_at)
);

-- ========================================
-- 8. DATOS INICIALES
-- ========================================

-- Usuario administrador por defecto
-- Contraseña: admin123 (cambiar en producción)
INSERT INTO users (username, email, password_hash, full_name, role) VALUES 
('admin', 'admin@transport.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'Administrador del Sistema', 'admin'),
('operador', 'operador@transport.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'Operador', 'operator');

-- Configuraciones básicas del sistema
INSERT INTO system_settings (setting_key, setting_value, setting_type, description, category) VALUES 
('site_name', 'Sistema de Gestión de Transporte', 'string', 'Nombre del sistema', 'general'),
('company_name', 'TransportMX', 'string', 'Nombre de la empresa', 'general'),
('default_currency', 'MXN', 'string', 'Moneda por defecto', 'financial'),
('max_upload_size', '10485760', 'number', 'Tamaño máximo de archivo en bytes (10MB)', 'uploads'),
('allowed_file_types', 'pdf', 'string', 'Tipos de archivo permitidos', 'uploads'),
('default_deduction_type', 'percentage', 'string', 'Tipo de deducción por defecto', 'financial'),
('default_deduction_value', '5.00', 'number', 'Valor de deducción por defecto', 'financial'),
('reports_per_page', '20', 'number', 'Reportes por página', 'interface'),
('session_timeout', '3600', 'number', 'Tiempo de sesión en segundos', 'security');

-- Empresas de ejemplo
INSERT INTO companies (name, legal_name, tax_id, contact_person, phone, email, deduction_type, deduction_value) VALUES 
('Transportes del Norte SA', 'Transportes del Norte S.A. de C.V.', 'TNO940525XX1', 'Juan Pérez', '555-0001', 'contacto@tnorte.com', 'percentage', 5.00),
('Fletes Rápidos', 'Fletes Rápidos del Pacífico S.A. de C.V.', 'FRP850315XX2', 'María González', '555-0002', 'info@fletesrapidos.com', 'percentage', 4.50),
('Carga Pesada MX', 'Carga Pesada Mexicana S.A. de C.V.', 'CPM920807XX3', 'Carlos Rodríguez', '555-0003', 'ventas@cargapesada.com', 'fixed_amount', 500.00);

-- Log inicial
INSERT INTO activity_logs (user_id, action, description, ip_address) VALUES 
(1, 'SYSTEM_INSTALL', 'Sistema instalado correctamente', '127.0.0.1');

-- ========================================
-- 9. VISTAS ÚTILES
-- ========================================

-- Vista de resumen por empresa
CREATE VIEW company_summary AS
SELECT 
    c.id,
    c.name,
    c.tax_id,
    COUNT(DISTINCT t.voucher_id) as total_vouchers,
    COUNT(t.id) as total_trips,
    SUM(t.weight_tons) as total_weight,
    SUM(t.subtotal) as gross_total,
    SUM(t.deduction_amount) as total_deductions,
    SUM(t.total_amount) as net_total,
    COUNT(r.id) as reports_generated
FROM companies c
LEFT JOIN trips t ON c.id = t.company_id
LEFT JOIN reports r ON c.id = r.company_id
WHERE c.is_active = 1
GROUP BY c.id, c.name, c.tax_id;

-- Vista de vouchers con estadísticas
CREATE VIEW voucher_stats AS
SELECT 
    v.id,
    v.voucher_number,
    v.original_filename,
    v.upload_date,
    v.status,
    COUNT(t.id) as total_trips,
    COUNT(DISTINCT t.company_id) as companies_count,
    SUM(t.weight_tons) as total_weight,
    SUM(t.total_amount) as total_amount,
    u.full_name as uploaded_by_name
FROM vouchers v
LEFT JOIN trips t ON v.id = t.voucher_id
LEFT JOIN users u ON v.uploaded_by = u.id
GROUP BY v.id, v.voucher_number, v.original_filename, v.upload_date, v.status, u.full_name;

-- ========================================
-- 10. ÍNDICES ADICIONALES PARA OPTIMIZACIÓN
-- ========================================

-- Índices compuestos para consultas frecuentes
CREATE INDEX idx_trips_voucher_company_date ON trips(voucher_id, company_id, trip_date);
CREATE INDEX idx_reports_company_period ON reports(company_id, period_start, period_end);
CREATE INDEX idx_vouchers_status_date ON vouchers(status, upload_date);

-- Índice de texto completo para búsquedas
ALTER TABLE companies ADD FULLTEXT(name, legal_name, contact_person);
ALTER TABLE trips ADD FULLTEXT(origin, destination, driver_name, product_type);

COMMIT;