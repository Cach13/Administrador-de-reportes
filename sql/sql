-- ========================================
-- TRANSPORT MANAGEMENT SYSTEM - NUEVA ESTRUCTURA BD
-- Flow: Voucher ‚Üí Extract ‚Üí Select Company ‚Üí Generate Report
-- ========================================

DROP DATABASE IF EXISTS transport_management;
CREATE DATABASE transport_management CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE transport_management;

-- ========================================
-- 1. TABLA DE USUARIOS
-- ========================================
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    full_name VARCHAR(100) NOT NULL,
    role ENUM('admin', 'operator') DEFAULT 'operator',
    avatar VARCHAR(255) NULL,
    phone VARCHAR(20) NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    last_login TIMESTAMP NULL,
    is_active BOOLEAN DEFAULT TRUE,
    failed_login_attempts INT DEFAULT 0,
    locked_until TIMESTAMP NULL,
    
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_role (role),
    INDEX idx_active (is_active)
);

-- ========================================
-- 2. TABLA DE EMPRESAS (CON IDENTIFICADOR 3 LETRAS)
-- ========================================
CREATE TABLE companies (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(150) NOT NULL,
    identifier VARCHAR(3) UNIQUE NOT NULL,           -- üÜï JAV, ABC, etc. (chars 4-6 del Vehicle ID)
    legal_name VARCHAR(200) NULL,
    tax_id VARCHAR(50) NULL,
    contact_person VARCHAR(100) NULL,
    phone VARCHAR(20) NULL,
    email VARCHAR(100) NULL,
    address TEXT NULL,
    city VARCHAR(100) NULL,
    state VARCHAR(100) NULL,
    postal_code VARCHAR(10) NULL,
    country VARCHAR(50) DEFAULT 'M√©xico',
    
    -- üÜï CONFIGURACI√ìN CAPITAL TRANSPORT
    capital_percentage DECIMAL(5,2) DEFAULT 5.00,   -- Variable por empresa (ej: 5%)
    current_payment_no INT DEFAULT 1,               -- Auto-increment por empresa
    last_payment_year YEAR DEFAULT NULL,            -- Para reset anual
    
    -- Configuraci√≥n bancaria
    bank_name VARCHAR(100) NULL,
    account_number VARCHAR(50) NULL,
    clabe VARCHAR(18) NULL,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    created_by INT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    
    FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL,
    INDEX idx_name (name),
    INDEX idx_identifier (identifier),               -- üÜï Para b√∫squedas r√°pidas
    INDEX idx_tax_id (tax_id),
    INDEX idx_active (is_active)
);

-- ========================================
-- 3. TABLA DE VOUCHERS (INPUT - MARTIN MARIETA)
-- ========================================
CREATE TABLE vouchers (
    id INT PRIMARY KEY AUTO_INCREMENT,
    voucher_number VARCHAR(100) UNIQUE NOT NULL,
    original_filename VARCHAR(255) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    file_size INT NOT NULL,
    file_hash VARCHAR(64) NULL,
    
    file_type ENUM('martin_marieta') DEFAULT 'martin_marieta',  -- Solo Martin Marieta por ahora
    file_format ENUM('pdf', 'xlsx', 'xls') NOT NULL,
    
    status ENUM('uploaded', 'processing', 'processed', 'error') DEFAULT 'uploaded',
    processing_started_at TIMESTAMP NULL,
    processing_completed_at TIMESTAMP NULL,
    processing_notes TEXT NULL,
    
    -- Estad√≠sticas del archivo
    total_rows_found INT DEFAULT 0,
    valid_rows_extracted INT DEFAULT 0,
    rows_with_errors INT DEFAULT 0,
    extraction_confidence DECIMAL(3,2) DEFAULT 0.00,
    
    upload_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    uploaded_by INT NOT NULL,
    
    FOREIGN KEY (uploaded_by) REFERENCES users(id) ON DELETE RESTRICT,
    INDEX idx_status (status),
    INDEX idx_upload_date (upload_date),
    INDEX idx_file_type (file_type),
    INDEX idx_uploaded_by (uploaded_by)
);

-- ========================================
-- 4. TABLA DE TRIPS (DATOS EXTRA√çDOS DEL VOUCHER)
-- ========================================
CREATE TABLE trips (
    id INT PRIMARY KEY AUTO_INCREMENT,
    voucher_id INT NOT NULL,
    company_id INT NOT NULL,
    
    -- Informaci√≥n del viaje (mapeada desde Martin Marieta)
    trip_date DATE NOT NULL,                        -- Ship Date ‚Üí trip_date
    location VARCHAR(200) NOT NULL,                 -- Location ‚Üí location
    ticket_number VARCHAR(100) NULL,               -- Ticket Number ‚Üí ticket_number
    haul_rate DECIMAL(10,2) NOT NULL DEFAULT 0.00, -- Haul Rate ‚Üí haul_rate
    quantity DECIMAL(8,2) NOT NULL DEFAULT 0.00,   -- Quantity ‚Üí quantity
    amount DECIMAL(12,2) NOT NULL DEFAULT 0.00,    -- Amount ‚Üí amount
    vehicle_number VARCHAR(20) NOT NULL,           -- Vehicle Number ‚Üí vehicle_number (9 chars)
    
    -- Metadatos de extracci√≥n
    source_row_number INT NULL,
    extraction_confidence DECIMAL(3,2) DEFAULT 1.00,
    manual_review_required BOOLEAN DEFAULT FALSE,
    manual_review_notes TEXT NULL,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (voucher_id) REFERENCES vouchers(id) ON DELETE CASCADE,
    FOREIGN KEY (company_id) REFERENCES companies(id) ON DELETE RESTRICT,
    
    INDEX idx_voucher_company (voucher_id, company_id),
    INDEX idx_trip_date (trip_date),
    INDEX idx_vehicle_number (vehicle_number),
    INDEX idx_ticket_number (ticket_number),
    INDEX idx_company_date (company_id, trip_date)
);

-- ========================================
-- 5. TABLA DE REPORTS (OUTPUT - CAPITAL TRANSPORT FORMAT)
-- ========================================
CREATE TABLE reports (
    id INT PRIMARY KEY AUTO_INCREMENT,
    company_id INT NOT NULL,
    voucher_id INT NOT NULL,
    
    -- üÜï CAMPOS √öNICOS CAPITAL TRANSPORT PAYMENT INFORMATION
    payment_no INT NOT NULL,                        -- Auto-increment por empresa/a√±o
    week_start DATE NOT NULL,                       -- Week Start
    week_end DATE NOT NULL,                         -- Week End
    payment_date DATE NOT NULL,                     -- Payment Date
    payment_total DECIMAL(12,2) NOT NULL,          -- Payment Total
    ytd_amount DECIMAL(12,2) NOT NULL,             -- YTD (Year To Date)
    subtotal DECIMAL(12,2) NOT NULL,               -- SUBTOTAL
    capital_percentage DECIMAL(5,2) NOT NULL,      -- Capital's %
    capital_deduction DECIMAL(12,2) NOT NULL,      -- Capital's deduction amount
    total_payment DECIMAL(12,2) NOT NULL,          -- TOTAL PAYMENT (subtotal - deduction)
    
    -- Metadatos del reporte
    report_title VARCHAR(200) NOT NULL DEFAULT 'CAPITAL TRANSPORT LLP PAYMENT INFORMATION',
    generation_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    generated_by INT NOT NULL,
    
    -- Estad√≠sticas
    total_trips INT NOT NULL DEFAULT 0,
    total_vehicle_count INT NOT NULL DEFAULT 0,
    
    -- Archivo generado
    file_path VARCHAR(500) NULL,
    file_format ENUM('pdf', 'excel', 'both') DEFAULT 'pdf',
    
    status ENUM('generated', 'sent', 'paid') DEFAULT 'generated',
    sent_date TIMESTAMP NULL,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (company_id) REFERENCES companies(id) ON DELETE RESTRICT,
    FOREIGN KEY (voucher_id) REFERENCES vouchers(id) ON DELETE RESTRICT,
    FOREIGN KEY (generated_by) REFERENCES users(id) ON DELETE RESTRICT,
    
    INDEX idx_company_payment (company_id, payment_no),
    INDEX idx_payment_date (payment_date),
    INDEX idx_week_period (week_start, week_end),
    INDEX idx_generation_date (generation_date),
    INDEX idx_status (status),
    
    UNIQUE KEY unique_company_payment_year (company_id, payment_no, YEAR(payment_date))
);

-- ========================================
-- 6. TABLA DE LOGS DE ACTIVIDAD
-- ========================================
CREATE TABLE activity_logs (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NULL,
    action VARCHAR(100) NOT NULL,
    description TEXT NOT NULL,
    ip_address VARCHAR(45) NULL,
    user_agent TEXT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL,
    INDEX idx_user_id (user_id),
    INDEX idx_action (action),
    INDEX idx_created_at (created_at)
);

-- ========================================
-- 7. INSERTAR DATOS INICIALES
-- ========================================

-- Usuario administrador por defecto
INSERT INTO users (username, email, password_hash, full_name, role) VALUES 
('admin', 'admin@transport.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'Administrador', 'admin');

-- Empresas de ejemplo con identificadores
INSERT INTO companies (name, identifier, legal_name, capital_percentage, created_by) VALUES 
('Johnson & Associates', 'JAV', 'Johnson & Associates LLC', 5.00, 1),
('Martin Construction', 'MAR', 'Martin Construction Company', 4.50, 1),
('Brown Transport', 'BRN', 'Brown Transport Solutions Inc', 6.00, 1),
('Wilson Logistics', 'WIL', 'Wilson Logistics Corp', 5.50, 1);

-- Log de instalaci√≥n
INSERT INTO activity_logs (user_id, action, description, ip_address) VALUES 
(1, 'SYSTEM_INSTALL', 'Sistema instalado - Nueva estructura BD con flujo Voucher ‚Üí Report', '127.0.0.1');

-- ========================================
-- 8. VISTAS √öTILES
-- ========================================

-- Vista de resumen por empresa
CREATE VIEW company_summary AS
SELECT 
    c.id,
    c.name,
    c.identifier,
    c.capital_percentage,
    c.current_payment_no,
    COUNT(DISTINCT v.id) as total_vouchers_processed,
    COUNT(DISTINCT t.id) as total_trips_extracted,
    COUNT(DISTINCT r.id) as total_reports_generated,
    COALESCE(SUM(r.total_payment), 0) as total_payments_made,
    COALESCE(SUM(r.capital_deduction), 0) as total_capital_deductions,
    MAX(r.payment_date) as last_payment_date
FROM companies c
LEFT JOIN trips t ON c.id = t.company_id
LEFT JOIN vouchers v ON t.voucher_id = v.id
LEFT JOIN reports r ON c.id = r.company_id
WHERE c.is_active = 1
GROUP BY c.id, c.name, c.identifier, c.capital_percentage, c.current_payment_no;

-- Vista de estad√≠sticas de vouchers
CREATE VIEW voucher_stats AS
SELECT 
    v.id,
    v.voucher_number,
    v.original_filename,
    v.status,
    v.total_rows_found,
    v.valid_rows_extracted,
    v.extraction_confidence,
    COUNT(DISTINCT t.company_id) as companies_found,
    COUNT(t.id) as total_trips,
    COALESCE(SUM(t.amount), 0) as total_amount,
    u.full_name as uploaded_by_name
FROM vouchers v
LEFT JOIN trips t ON v.id = t.voucher_id
LEFT JOIN users u ON v.uploaded_by = u.id
GROUP BY v.id, v.voucher_number, v.original_filename, v.status, 
         v.total_rows_found, v.valid_rows_extracted, v.extraction_confidence, u.full_name;

COMMIT;